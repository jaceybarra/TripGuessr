<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TripGuesser ‚Äì Daily Driving Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Keep your key here or load via env at build time -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJhWz8jA_KfdQCZ1jE_z8RPGuvcQBVKFM"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#1f2328;
      --muted:#6b7280;
      --primary:#2563eb;
      --primary-600:#1d4ed8;
      --success:#16a34a;
      --danger:#dc2626;
      --border:#e5e7eb;
      --chip:#eef2ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: grid;
      place-items: center;
      min-height: 100vh;
      padding: 16px;
    }
    #app {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.06);
      overflow: hidden;
      max-width: 1000px;
      width: 100%;
      display: grid;
      grid-template-rows: auto auto 1fr;
    }
    /* Header */
    #game-ui {
      padding: 22px 20px 14px;
      border-bottom: 1px solid var(--border);
    }
    #top-row { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    #title-wrap { display:flex; align-items:center; gap:10px; }
    #game-title { font-size: 26px; margin: 0; }
    #city-chip {
      font-size: 13px; color: var(--primary);
      background: var(--chip); border: 1px solid #dbe3ff;
      padding: 6px 10px; border-radius: 999px; font-weight:600;
    }
    #game-subtitle { margin: 6px 0 0; color: var(--muted); font-size: 14px; }
    /* Controls */
    #controls {
      display: grid; gap: 10px; padding: 14px 20px 6px;
      grid-template-columns: 1fr auto;
    }
    .control {
      display:flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:#fff;
    }
    .control label { font-size:12px; color:var(--muted); white-space:nowrap; }
    .control input[type="number"] { width:100%; border:none; outline:none; font-size:16px; }
    button.primary {
      background: var(--primary); color:#fff; border:none; border-radius:10px; padding:12px 16px; font-weight:700; cursor:pointer;
    }
    button.primary:hover { background: var(--primary-600); }
    button.secondary {
      background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px 14px; cursor:pointer; font-weight:600;
    }
    /* Progress + Result */
    #meta {
      display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 0 20px 14px;
    }
    #progress-wrap { width:100%; background:#f1f5f9; border-radius:999px; height:10px; overflow:hidden; border:1px solid var(--border); }
    #progress { height:100%; width:0%; background:var(--primary); transition:width .25s ease; }
    #result {
      padding: 10px 14px; margin: 0 20px 12px;
      border-radius:10px; border:1px dashed var(--border); color:var(--muted); font-weight:600; min-height: 44px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    #result .actual { color:var(--text); font-weight:700; }
    /* Guess history */
    #history {
      padding: 0 20px 14px; display:flex; gap:8px; flex-wrap:wrap;
    }
    .pill {
      border-radius:999px; padding:6px 10px; font-size:13px; border:1px solid var(--border); background:#fff;
    }
    .pill.ok { background:#ecfdf5; border-color:#bbf7d0; color:var(--success); }
    .pill.high { background:#fef2f2; border-color:#fecaca; color:var(--danger); }
    .pill.low  { background:#eff6ff; border-color:#bfdbfe; color:#1d4ed8; }
    /* Map */
    #map-container { height: 440px; width: 100%; border-top:1px solid var(--border); }
    #map { height: 100%; width: 100%; }
    /* Share row */
    #actions {
      padding: 12px 20px 18px; display:flex; gap:10px; justify-content:flex-end; align-items:center; border-top:1px solid var(--border);
    }
    #shareBtn { display:none; }
    .hint { color:var(--muted); font-size:12px; margin-right:auto; }
    @media (max-width: 720px) {
      #controls { grid-template-columns: 1fr; }
      #map-container { height: 360px; }
      #actions { flex-wrap:wrap; }
    }
  </style>
</head>
<body>
  <div id="app" role="application" aria-label="TripGuesser game">
    <div id="game-ui">
      <div id="top-row">
        <div id="title-wrap">
          <h1 id="game-title">üöó TripGuesser</h1>
          <span id="city-chip" aria-live="polite">City: ‚Äî</span>
        </div>
        <button class="secondary" id="newRouteBtn">üé≤ New Route</button>
      </div>
      <p id="game-subtitle">Guess today‚Äôs <strong>live traffic</strong> drive time from A ‚Üí B. You‚Äôve got <strong>5 tries</strong>. Win if you‚Äôre within <strong>¬±10%</strong> of the actual time.</p>
    </div>

    <div id="controls" aria-label="Game controls">
      <div class="control" title="Your guess in minutes">
        <label for="guessInput">Guess (min)</label>
        <input type="number" id="guessInput" inputmode="decimal" placeholder="e.g., 18" min="1" />
      </div>
      <button class="primary" id="submitBtn">‚úÖ Submit Guess</button>
    </div>

    <div id="meta">
      <div id="progress-wrap" aria-label="Guess progress">
        <div id="progress"></div>
      </div>
      <span class="hint" id="triesHint">0/5</span>
    </div>

    <div id="result" aria-live="polite">
      <span id="resultText">Press ‚ÄúNew Route‚Äù to start.</span>
      <span id="actualWrap" style="display:none;">Actual: <span class="actual" id="actualTime"></span> min</span>
    </div>

    <div id="history" aria-label="Guess history"></div>

    <div id="map-container"><div id="map"></div></div>

    <div id="actions">
      <span class="hint">Auto tolerance: ¬±10% of actual time.</span>
      <button class="secondary" id="shareBtn">üì§ Share Result</button>
    </div>
  </div>

  <script>
    // -------- Constants / State --------
    const TOL_PCT = 10;           // Fixed tolerance (best-practice)
    const maxGuesses = 5;

    let map, directionsService, directionsRenderer;
    let markers = [];
    let routeData = null;
    let guessCount = 0;

    const CITY_BOUNDS = {
      "San Francisco": { minLat:37.735, maxLat:37.81,  minLng:-122.52, maxLng:-122.38, center:{lat:37.7749, lng:-122.4194}},
      "New York":      { minLat:40.70,  maxLat:40.82,  minLng:-74.02,  maxLng:-73.92,  center:{lat:40.77,   lng:-73.97}},
      "Chicago":       { minLat:41.83,  maxLat:41.95,  minLng:-87.72,  maxLng:-87.60,  center:{lat:41.88,   lng:-87.63}},
      "Los Angeles":   { minLat:34.00,  maxLat:34.15,  minLng:-118.30, maxLng:-118.15, center:{lat:34.05,   lng:-118.25}},
      "Seattle":       { minLat:47.58,  maxLat:47.70,  minLng:-122.36, maxLng:-122.30, center:{lat:47.61,   lng:-122.33}},
    };

    // -------- Utilities --------
    function seededRandom(seed) { let x = Math.sin(seed) * 10000; return x - Math.floor(x); }
    function getUTCSeed(offset = 0) {
      const now = new Date();
      return now.getUTCFullYear() * 10000 + now.getUTCMonth() * 100 + now.getUTCDate() + offset;
    }
    function getCityOfTheDay() {
      const cityNames = Object.keys(CITY_BOUNDS);
      const index = Math.floor(seededRandom(getUTCSeed()) * cityNames.length);
      return cityNames[index];
    }
    function dailyLatLng(seedOffset = 0) {
      const city = getCityOfTheDay();
      const b = CITY_BOUNDS[city];
      const seed = getUTCSeed(seedOffset);
      return {
        lat: b.minLat + seededRandom(seed) * (b.maxLat - b.minLat),
        lng: b.minLng + seededRandom(seed + 42) * (b.maxLng - b.minLng),
      };
    }
    function distance(p1, p2) {
      const R = 6371; // km
      const dLat = (p2.lat - p1.lat) * Math.PI / 180;
      const dLon = (p2.lng - p1.lng) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 +
        Math.cos(p1.lat * Math.PI/180) * Math.cos(p2.lat * Math.PI/180) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    function getMidpoint(p1, p2) { return { lat: (p1.lat + p2.lat)/2, lng: (p1.lng + p2.lng)/2 }; }
    function clearMarkers() { for (const m of markers) m.setMap(null); markers = []; }
    function isWithinTolerance(guess, actual) { return Math.abs(actual - guess) <= (actual * TOL_PCT / 100); }

    function setProgress() {
      const pct = (guessCount / maxGuesses) * 100;
      document.getElementById("progress").style.width = `${pct}%`;
      document.getElementById("triesHint").textContent = `${guessCount}/${maxGuesses}`;
    }
    function addHistoryPill(guess, actual) {
      const pill = document.createElement("span");
      let cls = "pill";
      if (isWithinTolerance(guess, actual)) cls += " ok";
      else if (guess > actual) cls += " high";
      else cls += " low";
      pill.className = cls;
      const diffPct = Math.round((Math.abs(actual - guess)/actual)*100);
      pill.textContent = `${guess} min ¬∑ ${guess > actual ? "high" : (guess < actual ? "low" : "exact")} ¬∑ ${diffPct}%`;
      document.getElementById("history").appendChild(pill);
    }
    function lockInputs() {
      document.getElementById("guessInput").disabled = true;
      document.getElementById("submitBtn").disabled = true;
    }
    function unlockInputs() {
      document.getElementById("guessInput").disabled = false;
      document.getElementById("submitBtn").disabled = false;
    }
    function setResult(text, color) {
      const el = document.getElementById("resultText");
      el.textContent = text;
      el.style.color = color || "inherit";
    }

    // -------- Map / Route --------
    function initializeMap() {
      const city = getCityOfTheDay();
      document.getElementById("city-chip").textContent = `City: ${city}`;
      const center = CITY_BOUNDS[city].center;

      map = new google.maps.Map(document.getElementById("map"), { center, zoom: 13 });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map, suppressMarkers:true, preserveViewport:true,
        polylineOptions: { strokeOpacity: 0.9 }
      });
      new google.maps.TrafficLayer().setMap(map);
    }

    async function setupDailyRoute() {
      clearMarkers();
      document.getElementById("resultText").textContent = "Generating today‚Äôs route‚Ä¶";
      document.getElementById("actualWrap").style.display = "none";
      document.getElementById("actualTime").textContent = "";
      document.getElementById("history").innerHTML = "";
      document.getElementById("guessInput").value = "";
      document.getElementById("shareBtn").style.display = "none";
      routeData = null;
      guessCount = 0; setProgress(); unlockInputs();

      const city = getCityOfTheDay();
      document.getElementById("city-chip").textContent = `City: ${city}`;

      const origin = dailyLatLng(0);
      const destination = dailyLatLng(1);
      const dist = distance(origin, destination);

      // keep routes reasonable
      if (dist < 1 || dist > 30) {
        setResult("üö´ Invalid daily route generated. Try again.", "var(--danger)");
        return;
      }

      const route = await fetchRoute(origin, destination);
      if (route && route.routes?.[0]?.legs?.[0]?.duration_in_traffic) {
        const leg = route.routes[0].legs[0];
        const trafficMin = Math.max(1, Math.round(leg.duration_in_traffic.value / 60));
        routeData = { trafficMin, correctGuess: false, response: route };

        directionsRenderer.setDirections(route);
        markers.push(new google.maps.Marker({ position: origin, map, label: "A" }));
        markers.push(new google.maps.Marker({ position: destination, map, label: "B" }));
        map.setCenter(getMidpoint(origin, destination));
        map.setZoom(13);

        setResult(`Route ready. Win if you're within ¬±${TOL_PCT}% of the actual time.`);
      } else {
        setResult("‚ùå Could not load today‚Äôs route. Try refreshing.", "var(--danger)");
      }
    }

    function fetchRoute(origin, destination) {
      return new Promise((resolve) => {
        const now = new Date(Date.now() + 60000); // 1 min ahead helps traffic calc
        const request = {
          origin, destination,
          travelMode: google.maps.TravelMode.DRIVING,
          drivingOptions: { departureTime: now, trafficModel: google.maps.TrafficModel.BEST_GUESS },
        };
        directionsService.route(request, (response, status) => resolve(status === "OK" ? response : null));
      });
    }

    // -------- Gameplay --------
    function checkGuess() {
      if (!routeData) { setResult("Start a route first.", "var(--danger)"); return; }
      if (routeData.correctGuess || guessCount >= maxGuesses) {
        setResult("üö´ The game is over. Start a new route.", "var(--danger)"); return;
      }

      const val = document.getElementById("guessInput").value.trim();
      const guess = parseFloat(val);

      if (!val || isNaN(guess) || guess <= 0) {
        setResult("‚ö†Ô∏è Enter a valid positive number for minutes.", "var(--danger)");
        return;
      }

      guessCount++; setProgress();
      const actual = routeData.trafficMin;
      const within = isWithinTolerance(guess, actual);
      const diff = Math.abs(actual - guess);
      const hiLo = guess > actual ? "too high" : (guess < actual ? "too low" : "exact");

      addHistoryPill(guess, actual);

      if (within) {
        routeData.correctGuess = true;
        setResult(`üéØ Nailed it within ¬±${TOL_PCT}% in ${guessCount} ${guessCount===1?"try":"tries"}!`, "var(--success)");
        document.getElementById("actualTime").textContent = actual;
        document.getElementById("actualWrap").style.display = "inline";
        document.getElementById("shareBtn").style.display = "inline-block";
        lockInputs();
        return;
      }

      if (guessCount < maxGuesses) {
        const left = maxGuesses - guessCount;
        const pctOff = Math.round((diff/actual)*100);
        setResult(`‚ùå ${guess} min is ${hiLo} (${pctOff}% off). ${left} ${left===1?"guess":"guesses"} left.`);
      } else {
        setResult(`üõë Out of guesses.`, "var(--danger)");
        document.getElementById("actualTime").textContent = actual;
        document.getElementById("actualWrap").style.display = "inline";
        document.getElementById("shareBtn").style.display = "inline-block";
        lockInputs();
      }
    }

    function shareRoute() {
      const today = new Date().toDateString();
      const city = getCityOfTheDay();
      const didWin = routeData?.correctGuess ?? false;

      const message = didWin
        ? `üéØ I got within ¬±${TOL_PCT}% in ${guessCount} ${guessCount === 1 ? "try" : "tries"}!`
        : `üõë Used all ${maxGuesses} guesses on today‚Äôs route. Can you do better?`;
      const shareText =
        `üöó TripGuesser ‚Äì ${today}\n${message}\nüìç City: ${city}\nüëâ Play: https://jaceybarra.github.io/TripGuessr/`;

      navigator.clipboard.writeText(shareText).then(() => {
        alert("‚úÖ Result copied to clipboard!");
      });
    }

    // -------- Wire-up --------
    document.getElementById("submitBtn").addEventListener("click", checkGuess);
    document.getElementById("shareBtn").addEventListener("click", shareRoute);
    document.getElementById("newRouteBtn").addEventListener("click", setupDailyRoute);
    document.getElementById("guessInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") checkGuess(); });

    window.onload = initializeMap;
  </script>
</body>
</html>
