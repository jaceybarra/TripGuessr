<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TripGuessr â€“ Daily Driving Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- =========================
       Styles
  ========================== -->
  <style>
    :root {
      --bg: #f9fafb;
      --text: #111827;
      --muted: #6b7280;
      --card: #ffffff;
      --primary: #2563eb;
      --primary-contrast: #ffffff;
      --accent: #10b981;
      --danger: #ef4444;
      --shadow: 0 8px 30px rgba(0,0,0,0.08);
      --ring: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }
    .dark {
      --bg: #0d0f13;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --card: #12161c;
      --primary: #60a5fa;
      --primary-contrast: #0b1220;
      --accent: #34d399;
      --danger: #f87171;
      --shadow: 0 8px 30px rgba(0,0,0,0.35);
      --ring: 0 0 0 3px rgba(96, 165, 250, 0.25);
    }

    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      transition: background .25s ease, color .25s ease;
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--card);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      box-shadow: var(--shadow);
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 20px;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 16px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: inherit;
    }
    .logo {
      width: 48px; height: 48px;
      flex: 0 0 48px;
    }
    .title-wrap h1 {
      font-size: 1.25rem;
      margin: 0;
      line-height: 1.2;
      letter-spacing: 0.2px;
    }
    .title-wrap p {
      margin: 2px 0 0 0;
      color: var(--muted);
      font-size: .9rem;
    }

    /* Controls */
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      appearance: none;
      border: none;
      background: var(--primary);
      color: var(--primary-contrast);
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      letter-spacing: .2px;
      cursor: pointer;
      box-shadow: 0 2px 0 rgba(0,0,0,.1);
      transition: transform .04s ease, filter .2s ease, box-shadow .2s ease;
    }
    .btn.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(0,0,0,.1);
    }
    .btn:active { transform: translateY(1px); }
    .btn:focus-visible { outline: none; box-shadow: var(--ring); }
    .btn.small { padding: 8px 12px; font-size: .9rem; }

    /* Main layout */
    .grid {
      display: grid;
      grid-template-columns: 1.45fr 1fr;
      gap: 18px;
      align-items: start;
    }
    @media (max-width: 980px){
      .grid { grid-template-columns: 1fr; }
    }

    /* Map */
    #map {
      width: 100%;
      height: 520px;
      border-radius: 16px;
      background: #dfe7f3;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,.06);
      overflow: hidden;
    }

    /* Cards */
    .card {
      background: var(--card);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2 { margin: 4px 0 8px; font-size: 1.1rem; }
    .muted { color: var(--muted); }

    /* Guess panel â€“ make it impossible to miss */
    .guess-panel {
      position: relative;
      padding: 18px;
      border: 2px dashed rgba(37,99,235, .35);
      border-radius: 16px;
      background:
        radial-gradient(1200px 1200px at 105% -10%, rgba(37, 99, 235, .08), transparent 40%),
        radial-gradient(1200px 1200px at -5% 110%, rgba(16, 185, 129, .08), transparent 40%),
        var(--card);
    }
    .guess-panel .label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .5px;
      font-size: .78rem;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .input-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .input {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--bg);
      border: 1px solid rgba(0,0,0,.08);
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 1.05rem;
      min-width: 220px;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,.04);
    }
    .input input {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text);
      width: 120px;
      font-size: 1.1rem;
    }
    .input .suffix {
      color: var(--muted);
      font-weight: 600;
    }
    .hint {
      margin-top: 8px;
      font-size: .9rem;
      color: var(--muted);
    }
    .result {
      margin-top: 12px;
      font-weight: 700;
    }
    .result.ok { color: var(--accent); }
    .result.no { color: var(--danger); }
    .result.near { color: #f59e0b; }

    /* Email + Report */
    .email-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
    }
    .email-row input[type=email]{
      width: 100%;
      background: var(--bg);
      color: var(--text);
      border: 1px solid rgba(0,0,0,.08);
      padding: 11px 12px;
      border-radius: 12px;
      font-size: 1rem;
    }
    .report-block pre {
      background: var(--bg);
      border: 1px dashed rgba(0,0,0,.08);
      padding: 12px;
      border-radius: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 240px;
      overflow: auto;
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .9rem;
      margin: 0;
    }
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 8px;
    }
    .stat {
      background: var(--bg);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .stat .k { font-size: 1.15rem; font-weight: 800; }
    .stat .l { font-size: .8rem; color: var(--muted); }

    /* Leaderboard-ish (local) */
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: .95rem;
    }
    .table th, .table td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      text-align: left;
    }
    .table th { color: var(--muted); font-weight: 700; font-size: .85rem; }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(16,185,129,.12);
      color: #059669;
      font-size: .75rem;
      font-weight: 700;
      letter-spacing: .3px;
    }
    .tag.lose { background: rgba(239,68,68,.12); color: #b91c1c; }
    .tag.near { background: rgba(245,158,11,.12); color: #b45309; }
    .small {
      font-size: .85rem;
      color: var(--muted);
    }

    .spacer { height: 14px; }
    .sr-only {
      position: absolute;
      width: 1px; height: 1px;
      padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0;
    }
  </style>
</head>
<body>
  <!-- We default to LIGHT mode -->
  <script>
    // Ensure default light on first visit; store preference thereafter.
    (function(){
      try {
        const pref = localStorage.getItem('tg_theme');
        if (pref === 'dark') document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark'); // default light
      } catch(e){}
    })();
  </script>

  <!-- =========================
       Header
  ========================== -->
  <header>
    <div class="container">
      <div class="row">
        <a class="brand" href="#">
          <!-- Inline SVG logo so it always loads -->
          <svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" aria-hidden="true">
            <defs>
              <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0" stop-color="#2563eb"/>
                <stop offset="1" stop-color="#10b981"/>
              </linearGradient>
            </defs>
            <circle cx="32" cy="32" r="30" fill="url(#g)"/>
            <path d="M20 38c2-7 7-13 12-18 6-6 10-4 10 2 0 6-8 10-12 12-3 1-6 2-10 4z" fill="#ffffff" opacity=".5"/>
            <text x="32" y="39" text-anchor="middle" font-weight="800" font-family="ui-sans-serif, system-ui" font-size="16" fill="#fff">TG</text>
          </svg>
          <div class="title-wrap">
            <h1>TripGuessr</h1>
            <p class="small">Guess todayâ€™s drive time. Within <strong>10%</strong> counts as a win.</p>
          </div>
        </a>
        <div class="controls">
          <button id="themeBtn" class="btn secondary small" type="button" aria-pressed="false">Dark</button>
          <button id="reportBtn" class="btn secondary small" type="button">Download CSV</button>
          <!-- Optional Slack toggle (no webhook by default) -->
          <button id="slackBtn" class="btn secondary small" type="button" aria-pressed="false" title="Toggle Slack notifications (configure webhook in code)">Slack Off</button>
        </div>
      </div>
    </div>
  </header>

  <!-- =========================
       Main
  ========================== -->
  <main class="container" style="padding-top:18px;">
    <div class="grid">
      <!-- Map + Today Meta -->
      <section>
        <div id="map" role="region" aria-label="Map showing todayâ€™s hidden route"></div>
        <div class="spacer"></div>
        <div class="card">
          <h2>Todayâ€™s Challenge</h2>
          <p class="small">
            The route changes every day (based on your local date). The map shows the start and end markersâ€”no city names to keep it fair.
          </p>
          <div id="todayMeta" class="small muted"></div>
        </div>
      </section>

      <!-- Guess + Stats -->
      <aside>
        <div class="card guess-panel" id="guessCard" aria-live="polite">
          <div class="label">Enter Your Guess</div>
          <h2 style="margin:0 0 6px 0;">How long will the drive take?</h2>
          <div class="input-row" style="margin-top:8px;">
            <label class="sr-only" for="guessInput">Minutes</label>
            <div class="input" style="flex:1 1 260px;">
              <input id="guessInput" inputmode="numeric" pattern="[0-9]*" type="number" min="1" placeholder="e.g., 42" autocomplete="off" />
              <span class="suffix">minutes</span>
            </div>
            <button id="submitBtn" class="btn" type="button">Submit Guess</button>
          </div>
          <div class="hint">Pro tip: Â±10% counts as a win. We round to the nearest minute.</div>
          <div id="result" class="result" aria-live="polite"></div>
        </div>

        <div class="spacer"></div>

        <div class="card">
          <h2>Track Your Progress</h2>
          <p class="small">We already track this device locally. Add your email to keep a longer history across sessions on this device (no server required here).</p>
          <div class="email-row" style="margin-top:8px;">
            <input id="emailInput" type="email" placeholder="you@example.com" />
            <button id="saveEmailBtn" class="btn secondary" type="button">Save Email</button>
          </div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap: wrap;">
            <button id="viewReportBtn" class="btn secondary" type="button">View Report</button>
            <button id="clearEmailDataBtn" class="btn secondary" type="button">Clear Email Data</button>
          </div>
          <div class="report-block" id="reportBlock" style="margin-top:12px; display:none;">
            <div class="stat-grid">
              <div class="stat"><div class="k" id="statGames">0</div><div class="l">Games Played</div></div>
              <div class="stat"><div class="k" id="statWins">0</div><div class="l">Wins (â‰¤10%)</div></div>
              <div class="stat"><div class="k" id="statAvgErr">â€“</div><div class="l">Avg Abs Error (min)</div></div>
              <div class="stat"><div class="k" id="statAvgPct">â€“</div><div class="l">Avg % Error</div></div>
              <div class="stat"><div class="k" id="statStreak">0</div><div class="l">Longest Win Streak</div></div>
              <div class="stat"><div class="k" id="statBest">â€“</div><div class="l">Best Guess (min diff)</div></div>
            </div>
            <div style="margin-top:10px;">
              <pre id="reportText"></pre>
            </div>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="card">
          <h2>Your Recent Results (This Device)</h2>
          <table class="table" id="recentTable">
            <thead><tr><th>Date</th><th>Guess</th><th>Outcome</th><th>Diff</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </aside>
    </div>
  </main>

  <!-- =========================
       Scripts
  ========================== -->
  <script>
    // ---------------------------
    // Config / Constants
    // ---------------------------
    const TOLERANCE_PERCENT = 10;        // within 10% => WIN
    const NEAR_MISS_PERCENT = 15;        // optional "So close!" message if within 15% but not â‰¤10%
    const MAX_RECENT_ROWS = 12;
    const USE_SLACK = false;             // toggle run-time via button
    let SLACK_WEBHOOK_URL = "";          // <-- put your webhook here if you want Slack pings
    const DEVICE_KEY = "tg_device_id_v2";
    const DEVICE_RESULTS_KEY = "tg_device_results_v2";
    const EMAIL_KEY = "tg_email_v2";
    const THEME_KEY = "tg_theme";

    // ---------------------------
    // Utilities
    // ---------------------------
    function fmtPct(n){ return (n*100).toFixed(1) + "%"; }
    function clamp(n, a, b){ return Math.min(Math.max(n,a), b); }
    function toMinutes(seconds){ return Math.round(seconds/60); }
    function percentError(guess, actual){
      if (actual <= 0) return 1;
      return Math.abs(guess - actual) / actual;
    }
    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function saveJSON(key, obj){
      try { localStorage.setItem(key, JSON.stringify(obj)); } catch(e){}
    }
    function loadJSON(key, fallback){
      try {
        const s = localStorage.getItem(key);
        return s ? JSON.parse(s) : fallback;
      } catch(e){ return fallback; }
    }
    function getDeviceId(){
      let id = localStorage.getItem(DEVICE_KEY);
      if (!id){
        id = "dev_" + Math.random().toString(36).slice(2) + "_" + Date.now().toString(36);
        localStorage.setItem(DEVICE_KEY, id);
      }
      return id;
    }
    function csvEscape(s){
      if (s == null) return "";
      const str = String(s);
      if (/[",\n]/.test(str)) return `"${str.replace(/"/g,'""')}"`;
      return str;
    }
    function download(filename, text){
      const blob = new Blob([text], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Seeded RNG from date so route changes daily but is consistent for that day
    function xmur3(str){
      let h = 1779033703 ^ str.length;
      for (let i=0; i<str.length; i++){
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = h << 13 | h >>> 19;
      }
      return function() {
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        return (h ^= h >>> 16) >>> 0;
      }
    }
    function sfc32(a,b,c,d){
      return function(){
        a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0;
        let t = (a + b) | 0;
        a = b ^ b >>> 9;
        b = c + (c << 3) | 0;
        c = (c << 21 | c >>> 11);
        d = d + 1 | 0;
        t = t + d | 0;
        c = c + t | 0;
        return (t >>> 0) / 4294967296;
      }
    }
    function seededRandom(seedStr){
      const seed = xmur3(seedStr);
      return sfc32(seed(), seed(), seed(), seed());
    }

    // ---------------------------
    // City list (approx coords)
    // (A healthy list to ensure varied routes)
    // ---------------------------
    const CITIES = [
      {name:"Seattle, WA", lat:47.6062, lng:-122.3321},
      {name:"Portland, OR", lat:45.5152, lng:-122.6784},
      {name:"San Francisco, CA", lat:37.7749, lng:-122.4194},
      {name:"San Jose, CA", lat:37.3382, lng:-121.8863},
      {name:"Los Angeles, CA", lat:34.0522, lng:-118.2437},
      {name:"San Diego, CA", lat:32.7157, lng:-117.1611},
      {name:"Phoenix, AZ", lat:33.4484, lng:-112.0740},
      {name:"Tucson, AZ", lat:32.2226, lng:-110.9747},
      {name:"Las Vegas, NV", lat:36.1699, lng:-115.1398},
      {name:"Salt Lake City, UT", lat:40.7608, lng:-111.8910},
      {name:"Boise, ID", lat:43.6150, lng:-116.2023},
      {name:"Denver, CO", lat:39.7392, lng:-104.9903},
      {name:"Albuquerque, NM", lat:35.0844, lng:-106.6504},
      {name:"Santa Fe, NM", lat:35.6870, lng:-105.9378},
      {name:"Dallas, TX", lat:32.7767, lng:-96.7970},
      {name:"Austin, TX", lat:30.2672, lng:-97.7431},
      {name:"San Antonio, TX", lat:29.4241, lng:-98.4936},
      {name:"Houston, TX", lat:29.7604, lng:-95.3698},
      {name:"Oklahoma City, OK", lat:35.4676, lng:-97.5164},
      {name:"Tulsa, OK", lat:36.1540, lng:-95.9928},
      {name:"Kansas City, MO", lat:39.0997, lng:-94.5786},
      {name:"St. Louis, MO", lat:38.6270, lng:-90.1994},
      {name:"Minneapolis, MN", lat:44.9778, lng:-93.2650},
      {name:"Omaha, NE", lat:41.2565, lng:-95.9345},
      {name:"Des Moines, IA", lat:41.5868, lng:-93.6250},
      {name:"Chicago, IL", lat:41.8781, lng:-87.6298},
      {name:"Milwaukee, WI", lat:43.0389, lng:-87.9065},
      {name:"Madison, WI", lat:43.0731, lng:-89.4012},
      {name:"Detroit, MI", lat:42.3314, lng:-83.0458},
      {name:"Cleveland, OH", lat:41.4993, lng:-81.6944},
      {name:"Columbus, OH", lat:39.9612, lng:-82.9988},
      {name:"Cincinnati, OH", lat:39.1031, lng:-84.5120},
      {name:"Indianapolis, IN", lat:39.7684, lng:-86.1581},
      {name:"Louisville, KY", lat:38.2527, lng:-85.7585},
      {name:"Nashville, TN", lat:36.1627, lng:-86.7816},
      {name:"Memphis, TN", lat:35.1495, lng:-90.0490},
      {name:"Birmingham, AL", lat:33.5186, lng:-86.8104},
      {name:"Atlanta, GA", lat:33.7490, lng:-84.3880},
      {name:"Charlotte, NC", lat:35.2271, lng:-80.8431},
      {name:"Raleigh, NC", lat:35.7796, lng:-78.6382},
      {name:"Charleston, SC", lat:32.7765, lng:-79.9311},
      {name:"Savannah, GA", lat:32.0809, lng:-81.0912},
      {name:"Jacksonville, FL", lat:30.3322, lng:-81.6557},
      {name:"Orlando, FL", lat:28.5383, lng:-81.3792},
      {name:"Tampa, FL", lat:27.9506, lng:-82.4572},
      {name:"Miami, FL", lat:25.7617, lng:-80.1918},
      {name:"Ft. Lauderdale, FL", lat:26.1224, lng:-80.1373},
      {name:"Richmond, VA", lat:37.5407, lng:-77.4360},
      {name:"Washington, DC", lat:38.9072, lng:-77.0369},
      {name:"Baltimore, MD", lat:39.2904, lng:-76.6122},
      {name:"Philadelphia, PA", lat:39.9526, lng:-75.1652},
      {name:"Pittsburgh, PA", lat:40.4406, lng:-79.9959},
      {name:"Newark, NJ", lat:40.7357, lng:-74.1724},
      {name:"New York, NY", lat:40.7128, lng:-74.0060},
      {name:"Stamford, CT", lat:41.0534, lng:-73.5387},
      {name:"Hartford, CT", lat:41.7658, lng:-72.6734},
      {name:"Providence, RI", lat:41.8240, lng:-71.4128},
      {name:"Boston, MA", lat:42.3601, lng:-71.0589},
      {name:"Portland, ME", lat:43.6591, lng:-70.2568},
      {name:"Buffalo, NY", lat:42.8864, lng:-78.8784},
      {name:"Rochester, NY", lat:43.1566, lng:-77.6088}
    ];

    // ---------------------------
    // Theming (button toggles)
    // ---------------------------
    const themeBtn = document.getElementById("themeBtn");
    themeBtn.addEventListener("click", () => {
      const dark = document.documentElement.classList.toggle("dark");
      localStorage.setItem(THEME_KEY, dark ? "dark":"light");
      themeBtn.textContent = dark ? "Light" : "Dark";
      if (map){
        map.setOptions({ styles: dark ? MAP_STYLES_DARK : MAP_STYLES_LIGHT });
      }
    });
    // Set initial button text
    (function(){
      const dark = document.documentElement.classList.contains("dark");
      themeBtn.textContent = dark ? "Light" : "Dark";
    })();

    // ---------------------------
    // Slack toggle
    // ---------------------------
    const slackBtn = document.getElementById("slackBtn");
    let slackOn = USE_SLACK;
    slackBtn.addEventListener("click", () => {
      slackOn = !slackOn;
      slackBtn.textContent = slackOn ? "Slack On" : "Slack Off";
      slackBtn.setAttribute("aria-pressed", String(slackOn));
    });

    async function postToSlack(payload){
      try {
        if (!slackOn || !SLACK_WEBHOOK_URL) return;
        await fetch(SLACK_WEBHOOK_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
      } catch(e){ /* silent */ }
    }

    // ---------------------------
    // Email persistence
    // ---------------------------
    const emailInput = document.getElementById("emailInput");
    const saveEmailBtn = document.getElementById("saveEmailBtn");
    saveEmailBtn.addEventListener("click", () => {
      const v = (emailInput.value || "").trim();
      if (!v || !/^\S+@\S+\.\S+$/.test(v)) { alert("Please enter a valid email."); return; }
      localStorage.setItem(EMAIL_KEY, v);
      alert("Email saved for local tracking on this device.");
    });
    // load saved
    (function(){ emailInput.value = localStorage.getItem(EMAIL_KEY) || ""; })();

    // ---------------------------
    // Daily Route Generation
    // ---------------------------
    function pickDailyPair(){
      const seed = todayKey();
      const rnd = seededRandom(seed);
      // pick two distinct cities, ensure theyâ€™re not too close
      let i = Math.floor(rnd() * CITIES.length);
      let j = Math.floor(rnd() * CITIES.length);
      let tries = 0;
      const dist = (a,b) => {
        const R=6371;
        const toRad = d => d*Math.PI/180;
        const dLat = toRad(b.lat-a.lat);
        const dLng = toRad(b.lng-a.lng);
        const s1 = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
        return 2*R*Math.asin(Math.sqrt(s1));
      };
      while ((j===i || dist(CITIES[i], CITIES[j]) < 150) && tries++ < 50){
        j = Math.floor(rnd() * CITIES.length);
      }
      return { origin: CITIES[i], destination: CITIES[j] };
    }

    // ---------------------------
    // Google Maps styles (light/dark)
    // ---------------------------
    const MAP_STYLES_LIGHT = [
      {"elementType":"geometry","stylers":[{"color":"#ebe3cd"}]},
      {"elementType":"labels.text.fill","stylers":[{"color":"#523735"}]},
      {"elementType":"labels.text.stroke","stylers":[{"color":"#f5f1e6"}]},
      {"featureType":"administrative","elementType":"geometry.stroke","stylers":[{"color":"#c9b2a6"}]},
      {"featureType":"poi","elementType":"geometry","stylers":[{"color":"#dfd2ae"}]},
      {"featureType":"poi.park","elementType":"geometry.fill","stylers":[{"color":"#a5d6a7"}]},
      {"featureType":"road","elementType":"geometry","stylers":[{"color":"#f5f1e6"}]},
      {"featureType":"road.arterial","elementType":"geometry","stylers":[{"color":"#fdfcf8"}]},
      {"featureType":"road.highway","elementType":"geometry","stylers":[{"color":"#f8c967"}]},
      {"featureType":"water","elementType":"geometry.fill","stylers":[{"color":"#a1c4fd"}]}
    ];
    const MAP_STYLES_DARK = [
      {"elementType":"geometry","stylers":[{"color":"#1f2937"}]},
      {"elementType":"labels.text.fill","stylers":[{"color":"#e5e7eb"}]},
      {"elementType":"labels.text.stroke","stylers":[{"color":"#111827"}]},
      {"featureType":"administrative","elementType":"geometry.stroke","stylers":[{"color":"#374151"}]},
      {"featureType":"poi","elementType":"geometry","stylers":[{"color":"#111827"}]},
      {"featureType":"poi.park","elementType":"geometry.fill","stylers":[{"color":"#064e3b"}]},
      {"featureType":"road","elementType":"geometry","stylers":[{"color":"#0b1220"}]},
      {"featureType":"road.highway","elementType":"geometry","stylers":[{"color":"#1f2937"}]},
      {"featureType":"water","elementType":"geometry.fill","stylers":[{"color":"#0ea5e9"}]}
    ];

    // ---------------------------
    // Google Maps init
    // ---------------------------
    let map, directionsService, directionsRenderer, trafficLayer;
    let startMarker, endMarker;
    let ACTUAL_MINUTES = null;
    let TODAY_PAIR = null;

    window.initMap = function initMap(){
      const dark = document.documentElement.classList.contains("dark");
      map = new google.maps.Map(document.getElementById("map"), {
        center: {lat: 39.8283, lng: -98.5795}, // USA center
        zoom: 4,
        disableDefaultUI: true,
        gestureHandling: 'greedy',
        styles: dark ? MAP_STYLES_DARK : MAP_STYLES_LIGHT
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map,
        suppressMarkers: true,
        preserveViewport: true,
        polylineOptions: { strokeColor: "#2563eb", strokeWeight: 5, strokeOpacity: 0.9 }
      });
      trafficLayer = new google.maps.TrafficLayer();
      trafficLayer.setMap(map);

      // Pick route for today and render
      TODAY_PAIR = pickDailyPair();
      renderTodayMeta();
      plotRoute(TODAY_PAIR.origin, TODAY_PAIR.destination);
    };

    function renderTodayMeta(){
      const el = document.getElementById("todayMeta");
      const d = todayKey();
      // Do NOT reveal city names in text to keep fair
      el.textContent = `Date: ${d} â€” New route every day.`;
    }

    function placeMarkers(origin, destination){
      if (startMarker) startMarker.setMap(null);
      if (endMarker) endMarker.setMap(null);

      startMarker = new google.maps.Marker({
        position: {lat: origin.lat, lng: origin.lng},
        map,
        title: "Start",
        label: {text: "A", color: "#ffffff", fontWeight: "700"},
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: "#10b981",
          fillOpacity: 1,
          strokeColor: "#065f46",
          strokeWeight: 2
        }
      });

      endMarker = new google.maps.Marker({
        position: {lat: destination.lat, lng: destination.lng},
        map,
        title: "End",
        label: {text: "B", color: "#ffffff", fontWeight: "700"},
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: "#2563eb",
          fillOpacity: 1,
          strokeColor: "#1e40af",
          strokeWeight: 2
        }
      });
    }

    function plotRoute(origin, destination){
      placeMarkers(origin, destination);

      const request = {
        origin: {lat: origin.lat, lng: origin.lng},
        destination: {lat: destination.lat, lng: destination.lng},
        travelMode: google.maps.TravelMode.DRIVING,
        drivingOptions: {
          // Departure time slightly in the future to avoid "past" error and get live traffic
          departureTime: new Date(Date.now() + 2*60*1000)
        },
        provideRouteAlternatives: false,
        unitSystem: google.maps.UnitSystem.IMPERIAL
      };

      directionsService.route(request, (result, status) => {
        if (status === "OK" && result && result.routes && result.routes[0]){
          directionsRenderer.setDirections(result);
          // Compute duration (prefer duration_in_traffic if available)
          const legs = result.routes[0].legs || [];
          let seconds = 0;
          for (const leg of legs){
            if (leg.duration_in_traffic && typeof leg.duration_in_traffic.value === "number"){
              seconds += leg.duration_in_traffic.value;
            } else if (leg.duration && typeof leg.duration.value === "number") {
              seconds += leg.duration.value;
            }
          }
          ACTUAL_MINUTES = toMinutes(seconds);
          fitBoundsForRoute(result);
          enableGuessUI();
        } else {
          // Fallback: approximate based on haversine @ 60 mph
          console.warn("Directions failed:", status, result);
          ACTUAL_MINUTES = estimateByAir(origin, destination);
          enableGuessUI(true);
        }
      });
    }

    function fitBoundsForRoute(directionResult){
      const bounds = new google.maps.LatLngBounds();
      const route = directionResult.routes[0];
      for (const leg of route.legs){
        bounds.extend(leg.start_location);
        bounds.extend(leg.end_location);
      }
      map.fitBounds(bounds, { top: 50, left: 20, bottom: 50, right: 20 });
    }

    function estimateByAir(a,b){
      const R=6371;
      const toRad = d => d*Math.PI/180;
      const dLat = toRad(b.lat-a.lat);
      const dLng = toRad(b.lng-a.lng);
      const s1 = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      const km = 2*R*Math.asin(Math.sqrt(s1));
      const miles = km * 0.621371;
      const mph = 60; // crude
      return Math.max(5, Math.round((miles / mph) * 60));
    }

    function enableGuessUI(fallback=false){
      const submitBtn = document.getElementById("submitBtn");
      const guessInput = document.getElementById("guessInput");
      submitBtn.disabled = false;
      guessInput.disabled = false;
      guessInput.focus();
      if (fallback){
        document.getElementById("result").innerHTML =
          `<span class="small">Live traffic route lookup failed; using a reasonable estimate for todayâ€™s challenge.</span>`;
      } else {
        document.getElementById("result").textContent = "";
      }
    }

    // ---------------------------
    // Guess submission + Storage
    // ---------------------------
    const submitBtn = document.getElementById("submitBtn");
    const guessInput = document.getElementById("guessInput");
    submitBtn.addEventListener("click", onSubmit);
    guessInput.addEventListener("keydown", (e) => { if (e.key === "Enter") onSubmit(); });

    function onSubmit(){
      const resEl = document.getElementById("result");
      const guessVal = parseInt(guessInput.value, 10);
      if (!ACTUAL_MINUTES){
        resEl.textContent = "Route still loadingâ€”try again in a moment.";
        return;
      }
      if (Number.isNaN(guessVal) || guessVal <= 0){
        resEl.textContent = "Please enter a valid positive number.";
        resEl.className = "result no";
        return;
      }

      const pct = percentError(guessVal, ACTUAL_MINUTES);
      const within = pct <= (TOLERANCE_PERCENT/100);
      const near   = !within && pct <= (NEAR_MISS_PERCENT/100);
      const diff   = Math.abs(guessVal - ACTUAL_MINUTES);

      if (within){
        resEl.textContent = `ðŸŽ‰ Correct! Within ${TOLERANCE_PERCENT}%. You guessed ${guessVal} min.`;
        resEl.className = "result ok";
      } else if (near){
        resEl.textContent = `ðŸŸ¡ So close! You were ${diff} min off (â‰ˆ ${fmtPct(pct)}). Try again tomorrow.`;
        resEl.className = "result near";
      } else {
        resEl.textContent = `âŒ Not quite. You were ${diff} min off (â‰ˆ ${fmtPct(pct)}).`;
        resEl.className = "result no";
      }

      // Save results (device + optional email)
      saveResult({ guess: guessVal, actual: ACTUAL_MINUTES, pct, within, diff });

      // Optional Slack (does NOT reveal the actual time)
      postToSlack({
        text: "TripGuessr result",
        blocks: [
          { type:"section", text:{ type:"mrkdwn", text:`*TripGuessr â€“ ${todayKey()}*`}},
          { type:"section", text:{ type:"mrkdwn", text:`Result: ${within ? "WIN âœ…" : near ? "NEAR ðŸŸ¡" : "MISS âŒ"}`}},
          { type:"section", text:{ type:"mrkdwn", text:`Guess: *${guessVal} min* â€¢ Error: *${(pct*100).toFixed(1)}%*`}},
          { type:"context", elements:[{ type:"mrkdwn", text:"(We donâ€™t reveal the actual time in Slack)"}]}
        ]
      });

      // Update recent table
      renderRecent();
    }

    function saveResult(entry){
      const dkey = todayKey();
      const deviceId = getDeviceId();

      // Device-local history
      const dev = loadJSON(DEVICE_RESULTS_KEY, []);
      dev.push({
        date: dkey,
        deviceId,
        guess: entry.guess,
        actual: entry.actual,
        pct: entry.pct,
        within: entry.within,
        diff: entry.diff
      });
      saveJSON(DEVICE_RESULTS_KEY, dev);

      // Email history (still local, but keyed per-email)
      const email = (localStorage.getItem(EMAIL_KEY) || "").trim();
      if (email){
        const key = "tg_email_history_v2::" + email.toLowerCase();
        const arr = loadJSON(key, []);
        arr.push({
          date: dkey,
          guess: entry.guess,
          actual: entry.actual,
          pct: entry.pct,
          within: entry.within,
          diff: entry.diff
        });
        saveJSON(key, arr);
      }
    }

    // ---------------------------
    // Recent results (device)
    // ---------------------------
    function renderRecent(){
      const tbody = document.querySelector("#recentTable tbody");
      tbody.innerHTML = "";
      const dev = loadJSON(DEVICE_RESULTS_KEY, []);
      const latest = dev.slice(-MAX_RECENT_ROWS).reverse();
      for (const row of latest){
        const tr = document.createElement("tr");
        const date = document.createElement("td"); date.textContent = row.date;
        const guess = document.createElement("td"); guess.textContent = `${row.guess} min`;
        const outcome = document.createElement("td");
        const diff = document.createElement("td"); diff.textContent = `${row.diff} min`;

        const span = document.createElement("span");
        if (row.within){ span.textContent = "Win"; span.className = "tag"; }
        else if (row.pct <= (NEAR_MISS_PERCENT/100)){ span.textContent = "Near"; span.className = "tag near"; }
        else { span.textContent = "Miss"; span.className = "tag lose"; }
        outcome.appendChild(span);

        tr.append(date, guess, outcome, diff);
        tbody.appendChild(tr);
      }
    }

    // Initial render for recent
    renderRecent();

    // ---------------------------
    // Report (email)
    // ---------------------------
    const viewReportBtn = document.getElementById("viewReportBtn");
    const reportBlock = document.getElementById("reportBlock");
    const reportText = document.getElementById("reportText");
    const reportBtn = document.getElementById("reportBtn");
    const clearEmailDataBtn = document.getElementById("clearEmailDataBtn");

    function computeStats(arr){
      const total = arr.length;
      const wins = arr.filter(x => x.within).length;
      const avgAbs = total ? (arr.reduce((s,x)=> s + Math.abs(x.diff), 0) / total) : 0;
      const avgPct = total ? (arr.reduce((s,x)=> s + x.pct, 0) / total) : 0;
      // streak
      let streak=0, maxStreak=0;
      for (const x of arr){
        if (x.within){ streak++; maxStreak = Math.max(maxStreak, streak); }
        else streak = 0;
      }
      const best = total ? Math.min(...arr.map(x => Math.abs(x.diff))) : null;
      return { total, wins, avgAbs, avgPct, maxStreak, best };
    }

    function renderStats(stats){
      document.getElementById("statGames").textContent = stats.total;
      document.getElementById("statWins").textContent = stats.wins;
      document.getElementById("statAvgErr").textContent = stats.total ? stats.avgAbs.toFixed(1) : "â€“";
      document.getElementById("statAvgPct").textContent = stats.total ? (stats.avgPct*100).toFixed(1) + "%" : "â€“";
      document.getElementById("statStreak").textContent = stats.maxSt
