<!DOCTYPE html>
<html>
<head>
    <title>Google Maps Routing Example</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJhWz8jA_KfdQCZ1jE_z8RPGuvcQBVKFM"></script>
    <style>
        #map {
            height: 100%;
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div>
        <button onclick="setupNewRoute()">Find New Route</button>
        <div id="hint"></div>
        <div id="result"></div>
        <button id="shareBtn" style="display: none;">Share Route</button>
        <input type="text" id="guessInput" />
    </div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let markers = [];
        let hintsGiven = 0;

        function initializeMap() {
            // Initialize the map
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -34.397, lng: 150.644 },
                zoom: 8,
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
            });
        }

        function calculateRoute() {
            return new Promise((resolve) => {
                const now = new Date();
                now.setHours(14, 0, 0, 0); // Set time to 2 PM local time

                const request = {
                    origin: origin,
                    destination: destination,
                    travelMode: google.maps.TravelMode.DRIVING,
                    drivingOptions: {
                        departureTime: now,
                        trafficModel: google.maps.TrafficModel.BEST_GUESS,
                    },
                };

                directionsService.route(request, (response, status) => {
                    console.log("Full response:", response);

                    if (status === "OK" && response.routes[0]) {
                        const route = response.routes[0];
                        const leg = route.legs[0];

                        if (leg.duration && leg.duration_in_traffic) {
                            const actualDurationMinutes = Math.ceil(leg.duration_in_traffic.value / 60);
                            const durationWithoutTrafficMinutes = Math.ceil(leg.duration.value / 60);

                            console.log("Leg duration:", leg.duration);
                            console.log("Leg duration in traffic:", leg.duration_in_traffic);

                            if (actualDurationMinutes > 0 && actualDurationMinutes <= 120) {
                                console.log("Valid route found:", {
                                    distance: leg.distance.text,
                                    durationWithTraffic: leg.duration_in_traffic.text,
                                    durationWithoutTraffic: leg.duration.text,
                                    actualMinutes: actualDurationMinutes,
                                    withoutTrafficMinutes: durationWithoutTrafficMinutes,
                                });

                                // Set the route on the map
                                directionsRenderer.setMap(map);
                                directionsRenderer.setDirections(response);

                                // Adjust map bounds to show the entire route
                                const bounds = new google.maps.LatLngBounds();
                                route.overview_path.forEach((point) => {
                                    bounds.extend(point);
                                });
                                map.fitBounds(bounds);

                                resolve(true);
                                return;
                            }
                        }
                    }

                    console.log("Invalid route, retrying...", {
                        status: status,
                        hasResponse: !!response,
                        hasRoutes: response && response.routes && response.routes.length > 0,
                    });
                    resolve(false);
                });
            });
        }

        function setupNewRoute() {
            clearMarkers();
            if (directionsRenderer) {
                directionsRenderer.setMap(null);
            }

            hintsGiven = 0;
            document.getElementById("hint").textContent = "";
            document.getElementById("result").textContent = "";
            document.getElementById("shareBtn").style.display = "none";
            document.getElementById("guessInput").value = "";
            enableGuessInput(true);

            let validRoute = false;
            let attempts = 0;
            const maxAttempts = 20;

            const findValidRoute = async () => {
                do {
                    origin = randomLatLng();
                    destination = randomLatLng();
                    const dist = distance(origin, destination);
                    console.log("Generated points:", origin, destination, "Distance:", dist);

                    // Ensure points are within a reasonable geographic range
                    if (!isValidLatLng(origin) || !isValidLatLng(destination)) {
                        console.log("Invalid latitude or longitude generated, retrying...");
                        continue;
                    }
                } while (dist < 1 || dist > 15); // Between 1km and 15km apart

                const markerA = new google.maps.Marker({
                    position: origin,
                    map: map,
                    label: "A",
                });
                const markerB = new google.maps.Marker({
                    position: destination,
                    map: map,
                    label: "B",
                });
                markers.push(markerA, markerB);

                const success = await calculateRoute();
                if (success) {
                    validRoute = true;
                } else {
                    clearMarkers();
                    if (attempts < maxAttempts) {
                        attempts++;
                        await findValidRoute();
                    } else {
                        console.error("Could not find valid route after maximum attempts");
                    }
                }
            };

            findValidRoute().catch(console.error);
        }

        function clearMarkers() {
            for (let marker of markers) {
                marker.setMap(null);
            }
            markers = [];
        }

        function randomLatLng() {
            // Generate a random latitude and longitude within a reasonable range
            const lat = Math.random() * (90 - -90) + -90;
            const lng = Math.random() * (180 - -180) + -180;
            return { lat: lat, lng: lng };
        }

        function distance(p1, p2) {
            const R = 6371; // Earth's radius in km
            const dLat = (p2.lat - p1.lat) * Math.PI / 180;
            const dLon = (p2.lng - p1.lng) * Math.PI / 180;
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        function isValidLatLng(latLng) {
            return latLng.lat >= -90 && latLng.lat <= 90 && latLng.lng >= -180 && latLng.lng <= 180;
        }

        function enableGuessInput(enable) {
            document.getElementById("guessInput").disabled = !enable;
        }

        // Initialize the map when the window loads
        window.onload = initializeMap;
    </script>
</body>
</html>
