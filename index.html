<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TripGuessr - Random Route with Traffic</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 800px;
    margin: auto;
    padding: 1rem;
  }
  #map {
    width: 100%;
    height: 400px;
    margin-bottom: 1rem;
  }
  input[type=number] {
    width: 80px;
    padding: 0.3em;
  }
  button {
    padding: 0.5em 1em;
  }
  .hint {
    margin-top: 1em;
    background: #eef;
    padding: 1em;
    border-radius: 5px;
  }
  .result {
    margin-top: 1em;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>TripGuessr</h1>
<p>Guess the driving time from Point A to Point B in San Francisco!</p>

<div id="map"></div>

<label for="guessInput">Your guess (minutes): </label>
<input type="number" id="guessInput" min="1" />
<button id="guessBtn">Guess</button>

<div class="hint" id="hint"></div>
<div class="result" id="result"></div>
<button id="newRouteBtn">New Route</button>

<script>
  // Your Google Maps API key
  const API_KEY = "AIzaSyCchdbQOHM7IzdUAg28bk_h4mkRcTXo5Ak";

  let map, directionsService, directionsRenderer;
  let actualDurationMinutes = 0;
  let durationWithoutTrafficMinutes = 0;
  let hintsGiven = 0;
  let origin, destination;

  // San Francisco bounding box approx
  const bbox = {
    north: 37.812,
    south: 37.703,
    west: -122.527,
    east: -122.348
  };

  function randomLatLng() {
    const lat = Math.random() * (bbox.north - bbox.south) + bbox.south;
    const lng = Math.random() * (bbox.east - bbox.west) + bbox.west;
    return {lat, lng};
  }

  function loadGoogleMaps(callback) {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=${callback.name}&libraries=places`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  }

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 12,
      center: {lat: 37.7749, lng: -122.4194}
    });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({map: map});

    setupNewRoute();
  }

  function setupNewRoute() {
    hintsGiven = 0;
    document.getElementById('hint').textContent = "";
    document.getElementById('result').textContent = "";
    enableGuessInput(true);

    // generate random origin and destination (make sure they're distinct enough)
    do {
      origin = randomLatLng();
      destination = randomLatLng();
    } while (distance(origin, destination) < 5); // skip very short trips (<5 km)

    calculateRoute();
  }

  // Calculate distance in km between two lat/lng points using Haversine formula
  function distance(p1, p2) {
    const R = 6371; // km
    const dLat = (p2.lat - p1.lat) * Math.PI / 180;
    const dLng = (p2.lng - p1.lng) * Math.PI / 180;
    const a = 
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(p1.lat * Math.PI/180) * Math.cos(p2.lat * Math.PI/180) *
      Math.sin(dLng/2) * Math.sin(dLng/2)
    ;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function calculateRoute() {
    // Request with traffic info (departure_time=now)
    directionsService.route({
      origin: origin,
      destination: destination,
      travelMode: google.maps.TravelMode.DRIVING,
      drivingOptions: {
        departureTime: new Date(),
        trafficModel: 'best_guess'
      }
    }, (response, status) => {
      if (status === "OK") {
        directionsRenderer.setDirections(response);

        const leg = response.routes[0].legs[0];

        actualDurationMinutes = Math.round(leg.duration_in_traffic.value / 60);
        durationWithoutTrafficMinutes = Math.round(leg.duration.value / 60);

        // Display points on map markers with labels
        new google.maps.Marker({
          position: origin,
          map: map,
          label: "A"
        });
        new google.maps.Marker({
          position: destination,
          map: map,
          label: "B"
        });
      } else {
        alert("Directions request failed due to " + status);
      }
    });
  }

  document.getElementById("guessBtn").addEventListener("click", () => {
    const guessEl = document.getElementById("guessInput");
    const guess = parseInt(guessEl.value);
    if(isNaN(guess) || guess < 1){
      alert("Please enter a valid number of minutes.");
      return;
    }

    const resultDiv = document.getElementById("result");
    const hintDiv = document.getElementById("hint");

    const diff = Math.abs(guess - actualDurationMinutes);
    const tolerance = actualDurationMinutes * 0.1; // 10%

    if(diff <= tolerance){
      resultDiv.textContent = `Correct! The trip takes about ${actualDurationMinutes} minutes. Well done! ðŸŽ‰`;
      hintDiv.textContent = "";
      enableGuessInput(false);
    } else {
      hintsGiven++;
      if(hintsGiven === 1){
        hintDiv.textContent = `Hint #1: Time of day affects traffic. Current trip duration without traffic would be about ${durationWithoutTrafficMinutes} minutes.`;
      } else if(hintsGiven === 2){
        const delay = actualDurationMinutes - durationWithoutTrafficMinutes;
        const delayPercent = Math.round((delay / durationWithoutTrafficMinutes) * 100);
        hintDiv.textContent = `Hint #2: Traffic adds approximately ${delay} minutes (${delayPercent}%) to the trip time.`;
      } else if(hintsGiven === 3){
        hintDiv.textContent = `Hint #3: The route is about ${Math.round(distance(origin, destination))} km long.`;
      } else {
        resultDiv.textContent = `Game over! The actual trip time including traffic is ${actualDurationMinutes} minutes.`;
        hintDiv.textContent = "";
        enableGuessInput(false);
      }
      resultDiv.textContent = `Wrong guess: you guessed ${guess} minutes. Try again!`;
    }
    guessEl.value = "";
    guessEl.focus();
  });

  function enableGuessInput(enabled){
    const guessEl = document.getElementById("guessInput");
    const guessBtn = document.getElementById("guessBtn");
    guessEl.disabled = !enabled;
    guessBtn.disabled = !enabled;
  }

  document.getElementById("newRouteBtn").addEventListener("click", () => {
    directionsRenderer.setDirections({routes: []});
    setupNewRoute();
  });

  loadGoogleMaps(initMap);
</script>

</body>
</html>
