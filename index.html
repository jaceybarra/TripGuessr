<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>TripGuessr â€” Daily Driving Challenge</title>
  <meta name="theme-color" content="#0d0f13" />

  <style>
    :root{
      --bg:#f9fafb; --text:#0b1220; --muted:#6b7280; --card:#ffffff;
      --primary:#2563eb; --primary-contrast:#ffffff;
      --accent:#16a34a; --danger:#ef4444; --warn:#f59e0b;
      --ring:0 0 0 3px rgba(37,99,235,.25);
      --shadow:0 8px 28px rgba(0,0,0,.08);
      --border:1px solid rgba(2,6,23,.08);
      --input-bg:#ffffff; --input-border:1px solid rgba(2,6,23,.12);
      --kbd:#0b1220; --kbd-bg:#e5e7eb;
    }
    .dark{
      --bg:#0b1220; --text:#e5e7eb; --muted:#9aa4b2; --card:#121826;
      --primary:#60a5fa; --primary-contrast:#0b1220;
      --accent:#34d399; --danger:#f87171; --warn:#fbbf24;
      --ring:0 0 0 3px rgba(96,165,250,.35);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --border:1px solid rgba(148,163,184,.14);
      --input-bg:#0d1322; --input-border:1px solid rgba(148,163,184,.22);
      --kbd:#0b1220; --kbd-bg:#cbd5e1;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font: 16px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      transition:background .25s, color .25s;
    }
    a{color:inherit}
    .container{max-width:1120px; margin:0 auto; padding:16px 20px}

    header{
      position:sticky; top:0; z-index:40;
      background:var(--card); box-shadow:var(--shadow); border-bottom:var(--border);
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .brand{display:flex; gap:12px; align-items:center; text-decoration:none}
    .logo{width:40px; height:40px; border-radius:12px; display:grid; place-content:center; font-weight:800; background:var(--primary); color:var(--primary-contrast)}
    .title h1{font-size:1.15rem; margin:0}
    .title p{margin:2px 0 0 0; color:var(--muted); font-size:.9rem}

    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      appearance:none; border:var(--border); background:var(--card); color:var(--text);
      padding:10px 12px; border-radius:12px; font-weight:700; cursor:pointer;
    }
    .btn.primary{background:var(--primary); color:var(--primary-contrast); border:none}
    .btn.small{padding:8px 10px; font-weight:600}
    .btn[aria-pressed="true"]{outline:var(--ring)}

    main .grid{display:grid; grid-template-columns:1.45fr 1fr; gap:18px}
    @media (max-width:980px){ main .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card); border:var(--border); border-radius:16px; padding:16px; box-shadow:var(--shadow)
    }

    #map{width:100%; height:520px; border-radius:14px; overflow:hidden; background:#dbe7ff}
    .tries-banner{
      font-weight:700; font-size:.95rem; margin:0 0 8px 0; color:var(--muted);
    }

    .challenge{margin-top:12px; font-size:.95rem; color:var(--muted)}
    .challenge strong{color:var(--text)}

    .label{display:inline-flex; gap:8px; color:var(--muted); font-size:.75rem; text-transform:uppercase; font-weight:800; letter-spacing:.4px}
    .guess-panel{position:relative; border-radius:14px; border:2px dashed rgba(37,99,235,.28); padding:16px}
    .input{
      display:flex; align-items:center; gap:8px; border:var(--input-border); background:var(--input-bg);
      padding:12px 14px; border-radius:12px; min-width:220px
    }
    .input input{
      border:none; outline:none; background:transparent; color:var(--text); font-size:1.05rem; width:120px;
    }
    .suffix{color:var(--muted); font-weight:700}
    .hint{color:var(--muted); font-size:.9rem; margin-top:6px}
    .result{margin-top:12px; font-weight:800}
    .ok{color:var(--accent)} .no{color:var(--danger)} .near{color:var(--warn)}

    .email-row{display:grid; grid-template-columns:1fr auto; gap:8px}
    .email-row input{border:var(--input-border); background:var(--input-bg); color:var(--text); padding:10px 12px; border-radius:12px}

    .stats{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .stat{background:var(--input-bg); border:var(--input-border); border-radius:12px; padding:10px 12px}
    .stat .t{color:var(--muted); font-size:.8rem; font-weight:700; text-transform:uppercase; letter-spacing:.35px}
    .stat .v{font-weight:900; font-size:1.15rem}

    table{width:100%; border-collapse:collapse; font-size:.95rem}
    th,td{padding:8px 10px; border-bottom:var(--border); text-align:left}
    th{color:var(--muted); font-size:.8rem; font-weight:800}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; font-size:.75rem; font-weight:800; letter-spacing:.25px; background:rgba(16,185,129,.12); color:#059669}
    .tag.lose{background:rgba(239,68,68,.12); color:#b91c1c}
    .tag.near{background:rgba(245,158,11,.14); color:#9a640a}

    /* Onboarding Modal */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45);
    }
    .modal[open]{display:grid}
    .sheet{
      width:min(720px, calc(100% - 32px)); background:var(--card); color:var(--text);
      border:var(--border); border-radius:16px; box-shadow:var(--shadow); padding:18px;
    }
    .sheet header{position:relative; box-shadow:none; border:none; background:transparent; padding:0; margin-bottom:6px}
    .sheet h2{margin:0 0 4px 0}
    .sheet .steps{margin:6px 0 0 0; color:var(--muted)}
    .sheet .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}

    /* Confetti (lightweight) */
    .confetti{pointer-events:none; position:fixed; inset:0; overflow:hidden; z-index:60}
    .confetti span{
      position:absolute; width:10px; height:10px; border-radius:2px; opacity:0; transform:translateY(-20px);
      animation:fall 1400ms ease forwards;
    }
    @keyframes fall{
      0%{opacity:0; transform:translateY(-20px) rotate(0deg)}
      12%{opacity:1}
      100%{opacity:1; transform:translateY(110vh) rotate(540deg)}
    }

    :focus-visible{outline:var(--ring)}
    kbd{background:var(--kbd-bg); color:var(--kbd); padding:2px 6px; border-radius:6px; font-weight:700}
  </style>
</head>
<body>
  <header aria-label="Top bar">
    <div class="container row">
      <a class="brand" href="./">
        <div class="logo" aria-hidden="true">TG</div>
        <div class="title">
          <h1>TripGuessr</h1>
          <p>Guess todayâ€™s drive time. <strong>Within 10%</strong> counts as a win.</p>
        </div>
      </a>
      <div class="controls">
        <button id="helpBtn" class="btn small" aria-haspopup="dialog" aria-controls="helpModal">How it works</button>
        <button id="themeBtn" class="btn small" aria-pressed="false">Dark</button>
        <button id="csvBtn" class="btn small">Download CSV</button>
        <button id="slackBtn" class="btn small" aria-pressed="false" title="Post results to Slack when enabled">Slack Share: Off</button>
      </div>
    </div>
  </header>

  <main class="container" role="main">
    <div class="grid">
      <section class="card" aria-label="Map">
        <p id="triesBanner" class="tries-banner">Tries left: 5 of 5</p>
        <div id="map" role="img" aria-label="Map preview of todayâ€™s route"></div>
        <p id="todayMeta" class="challenge" aria-live="polite"></p>
        <div id="mapError" class="card" style="margin-top:12px; display:none">
          <strong>Heads up:</strong> the live route couldnâ€™t be loaded right now.
          Weâ€™ll use an estimated drive time for today so you can still play.
        </div>
      </section>

      <aside class="card" aria-label="Enter your guess">
        <div class="guess-panel">
          <span class="label">Enter your guess</span>
          <h3 style="margin:6px 0 10px 0; font-size:1.25rem">How long will the drive take?</h3>

          <div class="row" style="gap:10px">
            <div class="input" role="group" aria-label="Enter minutes">
              <input id="guessInput" type="number" min="1" inputmode="numeric" placeholder="e.g., 42" aria-label="Minutes" />
              <span class="suffix">minutes</span>
            </div>
            <button id="submitBtn" class="btn primary">Submit Guess</button>
            <button id="copyBtn" class="btn">Copy Result</button>
          </div>

          <p class="hint"><strong>You get 5 tries per day.</strong> Â±10% counts as a win (we donâ€™t reveal the actual time).</p>
          <p id="result" class="result" aria-live="polite"></p>
        </div>

        <div style="height:12px"></div>

        <div class="label">Track Your Progress</div>
        <p class="hint">Track on this device. Add email to keep history here across sessions.</p>
        <div class="email-row">
          <input id="emailInput" type="email" autocomplete="email" placeholder="you@example.com" />
          <button id="saveEmailBtn" class="btn">Save Email</button>
        </div>
        <div style="height:8px"></div>
        <div class="row" style="gap:8px">
          <button id="reportBtn" class="btn small">View Report</button>
          <button id="clearBtn" class="btn small">Clear Email Data</button>
        </div>

        <div style="height:14px"></div>
        <div class="stats" aria-label="Summary stats">
          <div class="stat"><div class="t">Games</div><div id="sGames" class="v">0</div></div>
          <div class="stat"><div class="t">Wins (â‰¤10%)</div><div id="sWins" class="v">0</div></div>
          <div class="stat"><div class="t">Best Guess</div><div id="sBest" class="v">â€“</div></div>
        </div>
      </aside>
    </div>

    <section class="card" style="margin-top:18px" aria-label="Recent results">
      <h3 style="margin:0 0 8px 0">Your Recent Results (This Device)</h3>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Guess</th><th>Outcome</th><th>Diff</th>
            </tr>
          </thead>
          <tbody id="recentTbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Onboarding Modal -->
  <dialog id="helpModal" class="modal" aria-labelledby="helpTitle" aria-modal="true">
    <div class="sheet" role="document">
      <header>
        <h2 id="helpTitle" style="margin:0">How TripGuessr works</h2>
        <p class="steps">A fresh route appears every day. Guess the driving time between two landmarks in a metro area.</p>
      </header>
      <ol style="padding-left:18px; margin:8px 0; color:var(--muted)">
        <li><strong>Look at the map</strong> for start (A) and end (B) landmarks. We donâ€™t reveal the exact route.</li>
        <li><strong>Guess the total minutes.</strong> You get <strong>5 tries</strong> per day.</li>
        <li><strong>Win</strong> if youâ€™re within <strong>Â±10%</strong> of the (hidden) drive time.</li>
        <li>Use <strong>Copy Result</strong> to share your score (Slack-style message). Enable <strong>Slack Share</strong> to auto-post.</li>
        <li>Toggle <strong>Dark/Light</strong>. Map restyles to match.</li>
      </ol>
      <p class="hint">Tip: keyboard submit with <kbd>Enter</kbd>. Increase contrast via Dark mode if labels are hard to read.</p>
      <div class="actions">
        <label style="display:flex; align-items:center; gap:8px; margin-right:auto">
          <input id="dontShowAgain" type="checkbox" /> Donâ€™t show again
        </label>
        <button id="closeHelpBtn" class="btn primary">Letâ€™s play</button>
      </div>
    </div>
  </dialog>

  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <script>
    // ------------------------ THEME (persisted) ------------------------
    (function applyThemeFromStorage(){
      try{
        const pref = localStorage.getItem('tg_theme');
        if(pref === 'dark'){ document.documentElement.classList.add('dark'); }
        else{ document.documentElement.classList.remove('dark'); }
        const themeBtn = document.getElementById('themeBtn');
        if(themeBtn) themeBtn.textContent = document.documentElement.classList.contains('dark') ? 'Light' : 'Dark';
      }catch(e){}
    })();

    // ------------------------ CONFIG ------------------------
    const TOLERANCE_PERCENT = 10;
    const MAX_TRIES_PER_DAY = 5;
    const MAX_RECENT_ROWS = 12;
    const MAX_MINUTES = 60;         // cap challenges to ~â‰¤ 60 minutes
    const MIN_KM = 5, MAX_KM = 80;  // min/max distance between landmarks
    const PUBLIC_URL = "https://jaceybarra.github.io/TripGuessr/";

    // Optional Slack webhook (leave empty to disable auto-post)
    let SLACK_WEBHOOK_URL = ""; // <-- put your Slack Incoming Webhook URL here (optional)
    let USE_SLACK = false;

    // Storage keys
    const DEVICE_KEY = "tg_device_id_v2";
    const DEVICE_RESULTS_KEY = "tg_device_results_v2";
    const EMAIL_KEY = "tg_email_v2";
    const PLAY_STATE_KEY = "tg_play_state_v1";
    const SEEN_ONBOARDING_KEY = "tg_seen_onboarding";

    // ------------------------ UTIL ------------------------
    const $ = sel => document.querySelector(sel);
    function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
    function saveJSON(k,o){ try{ localStorage.setItem(k, JSON.stringify(o)); }catch(e){} }
    function loadJSON(k,f){ try{ const s=localStorage.getItem(k); return s?JSON.parse(s):f; }catch(e){ return f; } }
    function getDeviceId(){ let id=localStorage.getItem(DEVICE_KEY); if(!id){ id="dev_"+Math.random().toString(36).slice(2)+"_"+Date.now().toString(36); localStorage.setItem(DEVICE_KEY,id);} return id; }
    function download(filename, text){ const blob=new Blob([text],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function toMinutes(s){ return Math.round(s/60); }
    function percentError(g,a){ return a<=0 ? 1 : Math.abs(g-a)/a; }

    // Seeded RNG (same each calendar day)
    function xmur3(str){ let h=1779033703^str.length; for(let i=0;i<str.length;i++){ h=Math.imul(h^str.charCodeAt(i),3432918353); h=h<<13|h>>>19; } return function(){ h=Math.imul(h^(h>>>16),2246822507); h=Math.imul(h^(h>>>13),3266489909); return (h^=h>>>16)>>>0; } }
    function sfc32(a,b,c,d){ return function(){ a>>>=0;b>>>=0;c>>>=0;d>>>=0; let t=(a+b)|0; a=b^b>>>9; b=c+(c<<3)|0; c=c<<21|c>>>11; d=d+1|0; t=t+d|0; c=c+t|0; return (t>>>0)/4294967296; } }
    function seededRandom(seed){ const s=xmur3(seed); return sfc32(s(),s(),s(),s()); }

    // Haversine (km)
    function kmBetween(a,b){
      const R=6371,toRad=d=>d*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(s1));
    }

    // ------------------------ LANDMARKS ------------------------
    const METROS = [
      { name:"Boston, MA", landmarks:[
        {n:"Fenway Park", c:"Boston, MA", lat:42.346676, lng:-71.097218},
        {n:"Harvard Yard", c:"Cambridge, MA", lat:42.374541, lng:-71.118021},
        {n:"Boston Common", c:"Boston, MA", lat:42.35501, lng:-71.06562},
        {n:"TD Garden", c:"Boston, MA", lat:42.366303, lng:-71.062228}
      ]},
      { name:"New York City, NY", landmarks:[
        {n:"Central Park (Bethesda Terrace)", c:"NYC, NY", lat:40.774036, lng:-73.970872},
        {n:"Times Square", c:"NYC, NY", lat:40.758001, lng:-73.9855},
        {n:"Yankee Stadium", c:"Bronx, NY", lat:40.829643, lng:-73.926175},
        {n:"Citi Field", c:"Queens, NY", lat:40.757088, lng:-73.845821}
      ]},
      { name:"Los Angeles, CA", landmarks:[
        {n:"Griffith Observatory", c:"Los Angeles, CA", lat:34.118434, lng:-118.300393},
        {n:"Dodger Stadium", c:"Los Angeles, CA", lat:34.073851, lng:-118.239958},
        {n:"Santa Monica Pier", c:"Santa Monica, CA", lat:34.009242, lng:-118.497604},
        {n:"Crypto.com Arena", c:"Los Angeles, CA", lat:34.043017, lng:-118.267254}
      ]},
      { name:"San Francisco Bay Area, CA", landmarks:[
        {n:"Golden Gate Park (Music Concourse)", c:"San Francisco, CA", lat:37.769421, lng:-122.486214},
        {n:"Oracle Park", c:"San Francisco, CA", lat:37.778595, lng:-122.38927},
        {n:"UC Berkeley (Sather Tower)", c:"Berkeley, CA", lat:37.871906, lng:-122.258522},
        {n:"Stanford Main Quad", c:"Stanford, CA", lat:37.4275, lng:-122.1697}
      ]},
      { name:"Washington, DC", landmarks:[
        {n:"Lincoln Memorial", c:"Washington, DC", lat:38.889268, lng:-77.050176},
        {n:"United States Capitol", c:"Washington, DC", lat:38.889939, lng:-77.009051},
        {n:"Smithsonian National Zoo", c:"Washington, DC", lat:38.9296, lng:-77.0497},
        {n:"Nationals Park", c:"Washington, DC", lat:38.873, lng:-77.0074}
      ]}
    ];

    function buildCandidates(metro){
      const out=[]; const L=metro.landmarks;
      for(let i=0;i<L.length;i++) for(let j=i+1;j<L.length;j++){
        const a=L[i], b=L[j]; const km=kmBetween(a,b);
        if(km>=MIN_KM && km<=MAX_KM) out.push([a,b]);
      }
      return out;
    }
    function pickDailyMetroAndPair(){
      const rnd = seededRandom(todayKey());
      const metro = METROS[Math.floor(rnd()*METROS.length)];
      const pairs = buildCandidates(metro);
      for(let i=pairs.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [pairs[i],pairs[j]]=[pairs[j],pairs[i]]; }
      return { metro, a:pairs[0][0], b:pairs[0][1] };
    }

    // ------------------------ MAP ------------------------
    let map, directionsService, directionsRenderer, startMarker, endMarker, currentActualMinutes = null;

    const MAP_STYLES_DARK = [
      {elementType:"geometry",stylers:[{color:"#0b1220"}]},
      {elementType:"labels.text.fill",stylers:[{color:"#e5e7eb"}]},
      {featureType:"poi",stylers:[{visibility:"off"}]},
      {featureType:"road",elementType:"geometry",stylers:[{color:"#29415f"}]},
      {featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#c7d2fe"}]},
      {featureType:"water",stylers:[{color:"#0e1726"}]}
    ];
    const MAP_STYLES_LIGHT = [
      {featureType:"poi",stylers:[{visibility:"off"}]},
      {featureType:"road",elementType:"geometry",stylers:[{color:"#e5edff"}]}
    ];

    function getRouteColor(){
      return document.documentElement.classList.contains('dark') ? "#60a5fa" : "#2563eb";
    }

    function setMarkers(a,b){
      if(startMarker) startMarker.setMap(null);
      if(endMarker) endMarker.setMap(null);
      startMarker = new google.maps.Marker({
        position:{lat:a.lat, lng:a.lng}, map, title:`${a.n} (${a.c})`,
        label:{text:"A", color:"#fff", fontWeight:"700"},
        icon:{path:google.maps.SymbolPath.CIRCLE, scale:10, fillColor:"#10b981", fillOpacity:1, strokeColor:"#065f46", strokeWeight:2}
      });
      endMarker = new google.maps.Marker({
        position:{lat:b.lat, lng:b.lng}, map, title:`${b.n} (${b.c})`,
        label:{text:"B", color:"#fff", fontWeight:"700"},
        icon:{path:google.maps.SymbolPath.CIRCLE, scale:10, fillColor:"#2563eb", fillOpacity:1, strokeColor:"#1e40af", strokeWeight:2}
      });
    }
    function renderTodayMetaNames(metro,a,b){
      const el = $("#todayMeta");
      if(el) el.innerHTML = `Start: <strong>${a.n}</strong> (${a.c}) â†’ End: <strong>${b.n}</strong> (${b.c}) â€” Metro: <strong>${metro.name}</strong>`;
    }
    function estimateByAir(a,b){
      const miles = kmBetween(a,b) * 0.621371;
      const mph = 35;
      return Math.max(5, Math.round((miles / mph) * 60));
    }

    window.initMap = function initMap(){
      try{
        const dark = document.documentElement.classList.contains('dark');
        map = new google.maps.Map(document.getElementById('map'), {
          center:{lat:39.8283,lng:-98.5795}, zoom:4, disableDefaultUI:true, gestureHandling:'greedy',
          styles: dark ? MAP_STYLES_DARK : MAP_STYLES_LIGHT
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          suppressMarkers: true,
          preserveViewport: false,
          polylineOptions: { strokeColor: getRouteColor(), strokeWeight: 6, strokeOpacity: 0.95 }
        });
        directionsRenderer.setMap(map);

        const {metro, a, b} = pickDailyMetroAndPair();
        setMarkers(a,b);
        renderTodayMetaNames(metro,a,b);

        directionsService.route({
          origin:{lat:a.lat,lng:a.lng}, destination:{lat:b.lat,lng:b.lng},
          travelMode: google.maps.TravelMode.DRIVING
        }, (res, status)=>{
          if(status === "OK" && res.routes[0] && res.routes[0].legs[0]){
            const leg = res.routes[0].legs[0];
            currentActualMinutes = toMinutes(leg.duration.value);
            directionsRenderer.setDirections(res); // draw the route polyline
          } else {
            $("#mapError").style.display = "block";
            currentActualMinutes = estimateByAir(a,b);
          }
          enableGuessUI(currentActualMinutes == null);
        });

      }catch(e){
        $("#mapError").style.display = "block";
        // Fallback with generic center
        map = new google.maps.Map(document.getElementById('map'), {center:{lat:39.8283,lng:-98.5795}, zoom:4, disableDefaultUI:true});
        const {metro, a, b} = pickDailyMetroAndPair();
        setMarkers(a,b); renderTodayMetaNames(metro,a,b);
        currentActualMinutes = estimateByAir(a,b);
        enableGuessUI(true);
      }
    };

    // ------------------------ PLAY STATE ------------------------
    function getPlayState(){
      const d = todayKey();
      let st = loadJSON(PLAY_STATE_KEY, null);
      if(!st || st.date !== d){
        st = { date:d, tries:0, won:false };
        saveJSON(PLAY_STATE_KEY, st);
      }
      return st;
    }
    function setPlayState(st){ saveJSON(PLAY_STATE_KEY, st); }
    function incrementTries(){ const st=getPlayState(); st.tries = Math.min(MAX_TRIES_PER_DAY, st.tries+1); setPlayState(st); return st; }
    function setWon(){ const st=getPlayState(); st.won = true; setPlayState(st); return st; }
    function triesLeft(){ const st=getPlayState(); return Math.max(0, MAX_TRIES_PER_DAY - st.tries); }
    function isLocked(){ const st=getPlayState(); return st.won || st.tries >= MAX_TRIES_PER_DAY; }

    function updateTriesBanner(){
      const el = $("#triesBanner"); if(!el) return;
      const st = getPlayState();
      if(st.won){ el.textContent = `You already won today! (Tries used: ${st.tries}/${MAX_TRIES_PER_DAY})`; el.style.color="var(--accent)"; }
      else if(st.tries >= MAX_TRIES_PER_DAY){ el.textContent = `Youâ€™ve used all ${MAX_TRIES_PER_DAY} tries today. Come back tomorrow!`; el.style.color="var(--danger)"; }
      else { el.textContent = `Tries left: ${MAX_TRIES_PER_DAY - st.tries} of ${MAX_TRIES_PER_DAY}`; el.style.color="var(--muted)"; }
    }
    function enforceTriesUI(){
      const st=getPlayState();
      const locked = st.won || st.tries >= MAX_TRIES_PER_DAY;
      const submitBtn = $("#submitBtn");
      const guessInput = $("#guessInput");
      if(submitBtn) submitBtn.disabled = locked;
      if(guessInput) guessInput.disabled = locked;
      updateTriesBanner();
    }

    // ------------------------ RESULTS STORAGE ------------------------
    function addDeviceResult(r){
      const arr = loadJSON(DEVICE_RESULTS_KEY, []);
      arr.unshift(r);
      while(arr.length > MAX_RECENT_ROWS) arr.pop();
      saveJSON(DEVICE_RESULTS_KEY, arr);
      renderRecent();
      renderStats();
    }

    function renderRecent(){
      const arr = loadJSON(DEVICE_RESULTS_KEY, []);
      const tb = $("#recentTbody");
      tb.innerHTML = "";
      for(const r of arr){
        const tr = document.createElement("tr");
        const tag = r.outcome === "WIN" ? "tag" : (r.outcome === "NEAR" ? "tag near" : "tag lose");
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.guess}m</td>
          <td><span class="${tag}">${r.outcome}</span></td>
          <td>${r.diff}</td>
        `;
        tb.appendChild(tr);
      }
    }

    function renderStats(){
      const arr = loadJSON(DEVICE_RESULTS_KEY, []);
      $("#sGames").textContent = String(arr.length);
      $("#sWins").textContent = String(arr.filter(r=>r.outcome==="WIN").length);
      const best = arr
        .filter(r=>r.outcome==="WIN")
        .slice()
        .sort((a,b)=>a.absErr - b.absErr)[0];
      $("#sBest").textContent = best ? `${best.guess}m (Î” ${best.diff})` : "â€“";
    }

    // ------------------------ SLACK SHARE ------------------------
    function slackTextSummary(resText){
      const d = todayKey();
      const meta = $("#todayMeta")?.textContent || "Todayâ€™s route";
      return `*TripGuessr â€” ${d}*\n*Route:* ${meta}\n*Result:* ${resText}\n<${PUBLIC_URL}|Play here>`;
    }
    async function postToSlack(payload){
      try{
        if(!USE_SLACK || !SLACK_WEBHOOK_URL) return;
        await fetch(SLACK_WEBHOOK_URL, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
      }catch(e){ /* silent */ }
    }

    // ------------------------ CONFETTI ------------------------
    function burstConfetti(){
      const root = $("#confetti");
      if(!root) return;
      const colors = ["#a78bfa","#60a5fa","#34d399","#fbbf24","#f87171"];
      for(let i=0;i<48;i++){
        const s = document.createElement("span");
        s.style.left = Math.random()*100 + "vw";
        s.style.background = colors[Math.floor(Math.random()*colors.length)];
        s.style.animationDelay = (Math.random()*0.3) + "s";
        s.style.transform = `translateY(-20px) rotate(${Math.random()*180}deg)`;
        root.appendChild(s);
        setTimeout(()=>s.remove(), 1600);
      }
    }

    // ------------------------ GAMEPLAY ------------------------
    function enableGuessUI(){
      const submitBtn=$("#submitBtn"), guessInput=$("#guessInput");
      if(submitBtn) submitBtn.disabled=false;
      if(guessInput){ guessInput.disabled=false; if(!isLocked()) guessInput.focus(); }
      enforceTriesUI();
    }

    function formatDiff(guess, actual){
      const abs = Math.abs(guess-actual);
      const pct = actual>0 ? Math.round((abs/actual)*100) : 0;
      return `${abs}m (${pct}%)`;
    }

    function handleSubmit(){
      const st = getPlayState();
      if(st.won || st.tries >= MAX_TRIES_PER_DAY) return;

      const val = parseInt(($("#guessInput").value||"").trim(),10);
      if(!val || val<=0){ $("#result").textContent = "Enter a positive number of minutes."; return; }
      const actual = currentActualMinutes ?? 42; // fallback guard

      incrementTries();

      const perr = percentError(val, actual);
      const outcome = perr <= (TOLERANCE_PERCENT/100) ? "WIN" : (perr <= .20 ? "NEAR" : "LOSE");

      const resEl = $("#result");
      if(outcome === "WIN"){
        resEl.className = "result ok";
        resEl.textContent = `You nailed it! Within ${TOLERANCE_PERCENT}% ðŸŽ‰`;
        setWon();
        burstConfetti();
      } else if(outcome === "NEAR"){
        resEl.className = "result near";
        resEl.textContent = `So close! Youâ€™re within 20%. Keep going.`;
      } else {
        resEl.className = "result no";
        resEl.textContent = `Not quite. Try again!`;
      }

      const diff = formatDiff(val, actual);
      const payloadText = slackTextSummary(`${outcome} â€” guess ${val}m | Î” ${diff}`);
      navigator.clipboard?.writeText(payloadText).catch(()=>{});

      // Save device result row
      addDeviceResult({
        date: todayKey(), guess: val, diff, absErr: Math.abs(val-actual), outcome
      });

      // Optionally auto-post to Slack
      postToSlack({ text: payloadText });

      enforceTriesUI();
    }

    // ------------------------ EVENTS ------------------------
    window.addEventListener('DOMContentLoaded', () => {
      // Theme toggle
      $("#themeBtn").addEventListener('click', ()=>{
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('tg_theme', isDark ? 'dark' : 'light');
        $("#themeBtn").textContent = isDark ? "Light" : "Dark";
        // Restyle map + route
        if(map) map.setOptions({ styles: isDark ? MAP_STYLES_DARK : MAP_STYLES_LIGHT });
        if(directionsRenderer) directionsRenderer.setOptions({ polylineOptions: { strokeColor: getRouteColor(), strokeWeight: 6, strokeOpacity: 0.95 } });
      });

      // Help modal
      const helpModal = $("#helpModal");
      $("#helpBtn").addEventListener('click', ()=>{ helpModal.showModal(); });
      $("#closeHelpBtn").addEventListener('click', ()=>{
        if($("#dontShowAgain").checked){ localStorage.setItem(SEEN_ONBOARDING_KEY, "1"); }
        helpModal.close();
      });
      if(!localStorage.getItem(SEEN_ONBOARDING_KEY)){ helpModal.showModal(); }

      // Slack toggle
      const slackBtn = $("#slackBtn");
      function refreshSlackBtn(){
        slackBtn.textContent = `Slack Share: ${USE_SLACK ? "On" : "Off"}`;
        slackBtn.setAttribute("aria-pressed", String(USE_SLACK));
        if(USE_SLACK && !SLACK_WEBHOOK_URL){
          alert("Add your Slack Incoming Webhook URL in the code to enable posting.");
          USE_SLACK = false;
        }
      }
      slackBtn.addEventListener('click', ()=>{ USE_SLACK = !USE_SLACK; refreshSlackBtn(); });
      refreshSlackBtn();

      // CSV export
      $("#csvBtn").addEventListener('click', ()=>{
        const arr = loadJSON(DEVICE_RESULTS_KEY, []);
        const header = "date,guess_minutes,outcome,diff\n";
        const rows = arr.map(r => `${r.date},${r.guess},${r.outcome},${r.diff}`).join("\n");
        download(`tripguessr_${getDeviceId()}.csv`, header + rows);
      });

      // Simple email store
      const email = localStorage.getItem(EMAIL_KEY)||"";
      $("#emailInput").value = email;
      $("#saveEmailBtn").addEventListener('click', ()=>{
        const v = $("#emailInput").value.trim();
        localStorage.setItem(EMAIL_KEY, v);
        alert("Saved. This stays only on this browser.");
      });
      $("#reportBtn").addEventListener('click', ()=>{
        const arr = loadJSON(DEVICE_RESULTS_KEY, []);
        alert(`Games: ${arr.length}\nWins: ${arr.filter(r=>r.outcome==="WIN").length}`);
      });
      $("#clearBtn").addEventListener('click', ()=>{
        localStorage.removeItem(EMAIL_KEY);
        alert("Email cleared.");
      });

      // Submit + Enter key
      $("#submitBtn").addEventListener('click', handleSubmit);
      $("#guessInput").addEventListener('keydown', (e)=>{ if(e.key==="Enter"){ handleSubmit(); } });

      // Copy result (current summary)
      $("#copyBtn").addEventListener('click', ()=>{
        const arr = loadJSON(DEVICE_RESULTS_KEY, []);
        const latest = arr[0];
        if(!latest){ alert("Play first, then copy!"); return; }
        const text = slackTextSummary(`${latest.outcome} â€” guess ${latest.guess}m | Î” ${latest.diff}`);
        navigator.clipboard?.writeText(text).then(()=>{ $("#result").textContent = "Copied result to clipboard!"; })
          .catch(()=>{ alert("Couldnâ€™t copy. Your browser may block clipboard access."); });
      });

      // Initial render
      renderRecent();
      renderStats();
      enforceTriesUI();
    });
  </script>

  <!-- Replace YOUR_API_KEY_HERE with your Google Maps JavaScript API key -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJhWz8jA_KfdQCZ1jE_z8RPGuvcQBVKFM&callback=initMap&loading=async"></script>
</body>
</html>
